@inject IStringLocalizer<Pages.Exercises> Loc

<div class="border border-2 rounded-3 my-5 @validationStyle">
    <div class="pt-3 px-3">
        <span class="h5">@Loc["SelectionExerciseHeader"]</span>
    </div>
    <hr/>
    <div class="text-center">
        <div class="fs-3">@Exercise.Question.Expression</div>
        <div class="small">@Exercise.Question.Language</div>
    </div>
    <div class="w-100 p-3 pt-2">
        @for (int i = 0; i < Exercise.PossibleAnswers.Count; i++)
        {
            var index = i;

            <div class="mt-2 @validationButtonStyle[i]">
                <input type="radio" class="btn-check" name="@String.Format("answer{0}", ExerciseNumber)" id="@String.Format("answer{0}{1}", ExerciseNumber, Exercise.PossibleAnswers[i].Expression)"
                       @onchange="@(() => UpdateAnswer(Exercise.PossibleAnswers[index]))" checked="@(Exercise.UserAnswer?.Equals(Exercise.PossibleAnswers[i]) ?? false)" autocomplete="off" disabled="@_disableButtons">
                <label class="btn btn-outline-primary w-100" for="@String.Format("answer{0}{1}", ExerciseNumber, Exercise.PossibleAnswers[i].Expression)">
                    <span class="d-block"><strong>@Exercise.PossibleAnswers[i].Expression</strong></span>
                    <span class="small d-block">@Exercise.PossibleAnswers[i].Language</span>
                </label>
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public required int ExerciseNumber { get; set; }

    [Parameter]
    public required Exercise Exercise { get; set; }

    [Parameter]
    public required EventCallback<(ExerciseEntry, int)> OnUserAnswered { get; set; }

    [Parameter]
    public required Action<Action> OnExerciseSheetSolved { get; set; }

    private bool _correctAnswer => Exercise.UserAnswer?.Equals(Exercise.Answer) ?? false;
    private bool _disableButtons = false;

    private string validationStyle = "";
    private List<string> validationButtonStyle = new(); 

    protected override void OnInitialized()
    {
        OnExerciseSheetSolved(UpdateStateToSolved);
        validationButtonStyle.Clear();
        foreach (var answer in Exercise.PossibleAnswers)
            validationButtonStyle.Add("");
    }

    private void UpdateAnswer(ExerciseEntry answer)
    {
        Exercise.UserAnswer = answer;
        OnUserAnswered.InvokeAsync((answer, ExerciseNumber));
    }

    private void UpdateStateToSolved()
    {
        _disableButtons = true;

        if (_correctAnswer)
        {
            validationStyle = "border-3 border-success";
        }
        else
        {
            validationStyle = "border-3 border-danger";
        }

        for (int i = 0; i < Exercise.PossibleAnswers.Count; i++)
        {
            if (Exercise.PossibleAnswers[i].Equals(Exercise.UserAnswer))
            {
                if (Exercise.PossibleAnswers[i].Equals(Exercise.Answer))
                    validationButtonStyle[i] = "border border-3 border-success rounded-3";
                else 
                    validationButtonStyle[i] = "border border-3 border-danger rounded-3";
            }
            else if (Exercise.PossibleAnswers[i].Equals(Exercise.Answer))
                validationButtonStyle[i] = "border border-3 border-warning rounded-3";
        }
    }
}
