@page "/{username}/sets/{folderId:int}/{setId:int}/exercises"

@using BlazorLanguageLearningApp.Client.Components;
@using BlazorLanguageLearningApp.Client.Components.Exercises;

@inject UserService UserService
@inject FolderService FolderService
@inject SetService SetService
@inject ExerciseService ExerciseService
@inject NavigationManager Navigation
@inject IStringLocalizer<Pages.Exercises> Loc

<Modal @ref="overwriteExerciseSheetModal" Title="@Loc["OverwriteExerciseSheetModalTitle"]" IsVerticallyCentered="true">
    <BodyTemplate>
        @Loc["OverwriteExerciseSheetModalText"]
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Secondary" @onclick="() => overwriteExerciseSheetModal.HideAsync()">@Loc["No"]</Button>
        <Button Color="ButtonColor.Primary" @onclick="GetQuickQuestion">@Loc["Yes"]</Button>
    </FooterTemplate>
</Modal>

@if (SetService.CurrentSet == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <PageTitle>@Loc["Exercises"] - @SetService.CurrentSet.Name</PageTitle>

    <div class="row d-lg-flex m-0 p-0">
        <SetsSubNav />

        <div class="content d-flex flex-column col-lg-9 col-xxl-10 px-0">
            <BreadcrumbNavigation CurrentPage="@Navigation.Uri" />

            <div class="container-fluid row border-bottom py-3 pe-0">
                <div class="col-6 col-sm-auto pe-1">
                    <ExerciseSheetModal ExerciseSheetExists="_exerciseSheetExists" ExerciseSheetChanged="OnExerciseSheetChanged" />
                </div>
                <div class="col-6 col-sm-auto">
                    <DeleteExerciseSheetModal ExerciseSheetExists="_exerciseSheetExists" ExerciseSheetChanged="OnExerciseSheetChanged" />
                </div>
                <div class="col-12 col-sm-auto pt-2 pt-sm-0 ps-sm-1">
                    <Button Type="ButtonType.Button" Color="ButtonColor.Primary" Class="w-100 h-100" @onclick="OnGetQuickQuestionClicked">
                        @Loc["QuickQuestion"]
                    </Button>
                </div>
                @if (_exerciseSheetExists)
                {
                    <div class="d-none d-sm-block d-flex justify-content-end col-sm-auto ms-auto">
                        <Button Type="ButtonType.Button" Color="ButtonColor.Success" @onclick="SubmitExerciseSheet" Disabled="CannotSubmit">
                            @Loc["Submit"]
                        </Button>
                    </div>
                }
            </div>
            <div class="exercise-sheet-container container-fluid">
                @if (_exerciseSheetExists)
                {
                    <div class="container-fluid" style="max-width: 900px;">
                        @for (int i = 0; i < _exerciseSheet!.Exercises.Count(); i++)
                        {
                            @if (_exerciseSheet.Exercises[i].Type == ExerciseType.Selection)
                            {
                                <SelectionExerciseComponent Exercise="_exerciseSheet.Exercises[i]" ExerciseNumber="@i" OnUserAnswered="UpdateUserAnswer" OnExerciseSheetSolved="AddExcerciseToListeners" @key="randomGuids[i]" />
                            }
                            @if (_exerciseSheet.Exercises[i].Type == ExerciseType.TrueOrFalse)
                            {
                                <TrueOrFalseExerciseComponent Exercise="_exerciseSheet.Exercises[i]" ExerciseNumber="@i" OnUserAnswered="UpdateUserAnswer" OnExerciseSheetSolved="AddExcerciseToListeners" @key="randomGuids[i]" />
                            }
                            @if (_exerciseSheet.Exercises[i].Type == ExerciseType.TypeIn)
                            {
                                <TypeInExerciseComponent Exercise="_exerciseSheet.Exercises[i]" ExerciseNumber="@i" OnUserAnswered="UpdateUserAnswer" OnExerciseSheetSolved="AddExcerciseToListeners" @key="randomGuids[i]" />
                            }
                        }
                    </div>
                }
            </div>
            @if (_exerciseSheetExists)
            {
                <hr class="d-block d-sm-none" />
                <div class="d-flex justify-content-center d-block d-sm-none pb-3">
                    <Button Type="ButtonType.Button" Color="ButtonColor.Success" Class="w-50" @onclick="SubmitExerciseSheet" Disabled="CannotSubmit">
                        @Loc["Submit"]
                    </Button>
                </div>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public required string Username { get; set; }

    [Parameter]
    public int FolderId { get; set; }

    [Parameter]
    public int SetId { get; set; }

    private Modal overwriteExerciseSheetModal = default!;

    private ExerciseSheet? _exerciseSheet;
    private bool _exerciseSheetExists => (_exerciseSheet is not null);
    private bool CannotSubmit => _exerciseSheet!.Solved || _exerciseSheet.Exercises.Any(e => !e.IsSolved());

    private List<Action> _exerciseUpdateMethods = new();

    private List<Guid> randomGuids = new();

    protected override void OnInitialized()
    {
        SetService.OnChange.Add(StateHasChanged);
    }

    protected async override Task OnParametersSetAsync()
    {
        try
        {
            await UserService.SetCurrentUser(Username);
            await FolderService.SetFolderById(Username, FolderId);
            await SetService.SetCurrentSetById(Username, FolderId, SetId);
            _exerciseSheet = await ExerciseService.GetExerciseSheetForSet();
            if (_exerciseSheetExists)
            {
                randomGuids.Clear();
                foreach (var exercise in _exerciseSheet!.Exercises)
                    randomGuids.Add(Guid.NewGuid());
            }
        }
        catch (HttpRequestException)
        {
            Navigation.NavigateTo("page-not-found");
        }
    }

    private async void OnGetQuickQuestionClicked()
    {
        if (!_exerciseSheetExists || _exerciseSheet!.Exercises.Count == 1)
            GetQuickQuestion();
        else
            await overwriteExerciseSheetModal.ShowAsync();
    }

    private async void GetQuickQuestion()
    {
        var result = await ExerciseService.GenerateExerciseSheet(1, true, true, true, true, true, true);
        if (result is not null)
        {
            _exerciseSheet = result;
            randomGuids = new() { Guid.NewGuid() };
            await overwriteExerciseSheetModal.HideAsync();
            StateHasChanged();
        }
    }

    private async void OnExerciseSheetChanged(ExerciseSheet? newSheet)
    {
        _exerciseSheet = newSheet;

        if (_exerciseSheet is null)
            await ExerciseService.DeleteExerciseSheet();
        else
        {
            randomGuids.Clear();
            foreach (var exercise in _exerciseSheet.Exercises)
                randomGuids.Add(Guid.NewGuid());
        }

        StateHasChanged();
    }

    private void UpdateUserAnswer((ExerciseEntry userAnswer, int exerciseNumber) answer)
    {
        _exerciseSheet!.Exercises[answer.exerciseNumber].UserAnswer = answer.userAnswer;
        StateHasChanged();
    }

    private bool GetExerciseSheetState() => _exerciseSheet!.Solved;

    private void AddExcerciseToListeners(Action exerciseUpdateMethod)
    {
        _exerciseUpdateMethods.Add(exerciseUpdateMethod);
    }

    private async void SubmitExerciseSheet()
    {
        if (_exerciseSheet is null)
            return;

        SheetValidationResult validationResult = await ExerciseService.ValidateExerciseSheet(_exerciseSheet);
        foreach (var exercise in _exerciseSheet.Exercises)
        {
            foreach (var answer in validationResult.Answers)
            {
                exercise.Answer = answer;
            }
        }
        _exerciseSheet.Solved = true;

        foreach (var a in _exerciseUpdateMethods)
            a.Invoke();

        StateHasChanged();
    }
}
